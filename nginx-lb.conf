# Nginx Load Balancer para Ollama AMD Dual GPU
# Distribui requisições entre RX 9060 e RX 6600 XT

events {
    worker_connections 1024;
}

http {
    upstream ollama_cluster {
        # Peso baseado na capacidade de VRAM
        # RX 9060 16GB = peso 2 (mais requisições)
        # RX 6600 XT 8GB = peso 1
        server ollama-amd-9060:11434 weight=2;
        server ollama-amd-6600xt:11434 weight=1;
        
        # Mantém conexão com mesmo backend por IP
        ip_hash;
    }

    server {
        listen 80;
        server_name _;

        # Aumentar timeouts para modelos grandes
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
        send_timeout 600;

        # Buffer para respostas grandes
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        location / {
            proxy_pass http://ollama_cluster;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";
            
            # SSE (Server-Sent Events) para streaming
            proxy_set_header Accept-Encoding "";
            proxy_buffering off;
            chunked_transfer_encoding on;
        }

        # Health check endpoint
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
    }
}
